From 1fa84886d07b4b2418fbbbee27ab67d86a5ee9ef Mon Sep 17 00:00:00 2001
From: Andre Heinecke <Andre Heinecke aheinecke@intevation.de>
Date: Fri, 1 Oct 2010 10:17:10 +0200
Subject: [PATCH] exchange-malloc-against-dlmalloc-for-wince

---
 src/corelib/global/global.pri  |    4 ++++
 src/corelib/global/qmalloc.cpp |   22 ++++++++++++++++++----
 2 files changed, 22 insertions(+), 4 deletions(-)

diff --git a/src/corelib/global/global.pri b/src/corelib/global/global.pri
index 4800716..9730818 100644
--- a/src/corelib/global/global.pri
+++ b/src/corelib/global/global.pri
@@ -7,12 +7,16 @@ HEADERS +=  \
         global/qnumeric_p.h \
         global/qnumeric.h
 
+wince*:HEADERS += global/dlmalloc.h
+
 SOURCES += \
 	global/qglobal.cpp \
         global/qlibraryinfo.cpp \
 	global/qmalloc.cpp \
         global/qnumeric.cpp
 
+wince*:SOURCES += global/dlmalloc.c
+
 # qlibraryinfo.cpp includes qconfig.cpp
 INCLUDEPATH += $$QT_BUILD_TREE/src/corelib/global
 
diff --git a/src/corelib/global/qmalloc.cpp b/src/corelib/global/qmalloc.cpp
index 090998c..be9b274 100644
--- a/src/corelib/global/qmalloc.cpp
+++ b/src/corelib/global/qmalloc.cpp
@@ -41,6 +41,8 @@
 
 #include "qplatformdefs.h"
 
+#include "dlmalloc.h"
+
 #include <stdlib.h>
 
 /*
@@ -52,17 +54,29 @@ QT_BEGIN_NAMESPACE
 
 void *qMalloc(size_t size)
 {
-    return ::malloc(size);
+#ifdef _WIN32_WCE
+    return ::dlmalloc(size);
+#else
+	return ::malloc(size);
+#endif
 }
 
 void qFree(void *ptr)
 {
-    ::free(ptr);
+#ifdef _WIN32_WCE
+    ::dlfree(ptr);
+#else
+	::free(ptr);
+#endif
 }
 
 void *qRealloc(void *ptr, size_t size)
 {
-    return ::realloc(ptr, size);
+#ifdef _WIN32_WCE
+    return ::dlrealloc(ptr, size);
+#else
+	return realloc(ptr, size);
+#endif
 }
 
 void *qMallocAligned(size_t size, size_t alignment)
@@ -120,7 +134,7 @@ void qFreeAligned(void *ptr)
     if (!ptr)
         return;
     void **ptr2 = static_cast<void **>(ptr);
-    free(ptr2[-1]);
+    qFree(ptr2[-1]);
 }
 
 QT_END_NAMESPACE
-- 
1.5.6.5

