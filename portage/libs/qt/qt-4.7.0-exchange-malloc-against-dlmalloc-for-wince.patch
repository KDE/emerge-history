From 40a6cce5fc97ab9a70e9a325b981042deb3564c7 Mon Sep 17 00:00:00 2001
From: Andreas Holzammer <andy@kdab.com>
Date: Mon, 6 Dec 2010 15:21:37 +0100
Subject: [PATCH] exchange malloc against dlmalloc for wince

---
 src/corelib/global/global.pri  |    4 +++
 src/corelib/global/qmalloc.cpp |   59 +++++++++++++++++++++++++++++++++++++---
 2 files changed, 59 insertions(+), 4 deletions(-)

diff --git a/src/corelib/global/global.pri b/src/corelib/global/global.pri
index 4800716..12391f4 100644
--- a/src/corelib/global/global.pri
+++ b/src/corelib/global/global.pri
@@ -7,12 +7,16 @@ HEADERS +=  \
         global/qnumeric_p.h \
         global/qnumeric.h
 
+wince*:HEADERS += global/dlmalloc.h
+
 SOURCES += \
 	global/qglobal.cpp \
         global/qlibraryinfo.cpp \
 	global/qmalloc.cpp \
         global/qnumeric.cpp
 
+wince*:SOURCES += global/dlmalloc.c
+
 # qlibraryinfo.cpp includes qconfig.cpp
 INCLUDEPATH += $$QT_BUILD_TREE/src/corelib/global
 
diff --git a/src/corelib/global/qmalloc.cpp b/src/corelib/global/qmalloc.cpp
index 090998c..60e395e 100644
--- a/src/corelib/global/qmalloc.cpp
+++ b/src/corelib/global/qmalloc.cpp
@@ -41,6 +41,8 @@
 
 #include "qplatformdefs.h"
 
+#include "dlmalloc.h"
+
 #include <stdlib.h>
 
 /*
@@ -50,19 +52,68 @@
 
 QT_BEGIN_NAMESPACE
 
+static bool initialized = false;
+static bool use_dlmalloc = false;
+
+void qmalloc_init()
+{
+  TCHAR filename[MAX_PATH];
+  GetModuleFileName(GetModuleHandle(NULL), filename, MAX_PATH );
+  use_dlmalloc = (wcscmp(filename,L"\\Programme\\Kontact-Mobile\\bin\\kmail-mobile.exe") == 0) ||
+    (wcscmp(filename,L"\\Programme\\Kontact-Mobile\\bin\\kaddressbook-mobile.exe") == 0) ||
+    (wcscmp(filename,L"\\Programme\\Kontact-Mobile\\bin\\korganizer-mobile.exe") == 0) ||
+    (wcscmp(filename,L"\\Programme\\Kontact-Mobile\\bin\\notes-mobile.exe") == 0) ||
+    (wcscmp(filename,L"\\Programme\\Kontact-Mobile\\bin\\tasks-mobile.exe") == 0) ||
+    (wcscmp(filename,L"\\Programme\\Kontact-Mobile\\bin\\akonadi_agent_server.exe") == 0) ||
+    (wcscmp(filename,L"\\Programme\\Kontact-Mobile\\bin\\akonadi_imap_resource.exe") == 0) ||
+    (wcscmp(filename,L"\\Programme\\Kontact-Mobile\\bin\\akonadiserver.exe") == 0);
+  initialized = true;
+}
+
 void *qMalloc(size_t size)
 {
-    return ::malloc(size);
+#ifdef _WIN32_WCE
+    if (!initialized) {
+        qmalloc_init();
+    }
+    if (use_dlmalloc) {
+        return ::dlmalloc(size);
+    } else {
+        return ::malloc(size);
+    }
+#else
+	return ::malloc(size);
+#endif
 }
 
 void qFree(void *ptr)
 {
-    ::free(ptr);
+#ifdef _WIN32_WCE
+    if (!initialized) {
+        qmalloc_init();
+    }
+    if (use_dlmalloc) {
+        ::dlfree(ptr);
+    } else {
+        ::free(ptr);
+    }
+#else
+	::free(ptr);
+#endif
 }
 
 void *qRealloc(void *ptr, size_t size)
 {
-    return ::realloc(ptr, size);
+#ifdef _WIN32_WCE
+    if (!initialized)
+        qmalloc_init();
+    if (use_dlmalloc)
+        return ::dlrealloc(ptr, size);
+    else
+        return realloc(ptr, size);
+#else
+	return realloc(ptr, size);
+#endif
 }
 
 void *qMallocAligned(size_t size, size_t alignment)
@@ -120,7 +171,7 @@ void qFreeAligned(void *ptr)
     if (!ptr)
         return;
     void **ptr2 = static_cast<void **>(ptr);
-    free(ptr2[-1]);
+    qFree(ptr2[-1]);
 }
 
 QT_END_NAMESPACE
-- 
1.7.0.2.msysgit.0

