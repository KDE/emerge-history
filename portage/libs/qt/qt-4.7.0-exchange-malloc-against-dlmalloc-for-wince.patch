From 5349e6be9f81f5b0bd86b191c3649150e472a63a Mon Sep 17 00:00:00 2001
From: Andreas Holzammer <andy@kdab.com>
Date: Thu, 30 Sep 2010 09:24:55 +0200
Subject: [PATCH] - exchange malloc against dlmalloc for wince

---
 src/corelib/global/global.pri  |    4 ++++
 src/corelib/global/qmalloc.cpp |   20 +++++++++++++++++---
 2 files changed, 21 insertions(+), 3 deletions(-)

diff --git a/src/corelib/global/global.pri b/src/corelib/global/global.pri
index 4800716..91239de 100644
--- a/src/corelib/global/global.pri
+++ b/src/corelib/global/global.pri
@@ -6,6 +6,8 @@ HEADERS +=  \
         global/qendian.h \
         global/qnumeric_p.h \
         global/qnumeric.h
+        
+wince*:HEADERS += global/dlmalloc.h
 
 SOURCES += \
 	global/qglobal.cpp \
@@ -13,6 +15,8 @@ SOURCES += \
 	global/qmalloc.cpp \
         global/qnumeric.cpp
 
+wince*:SOURCES += global/dlmalloc.c
+
 # qlibraryinfo.cpp includes qconfig.cpp
 INCLUDEPATH += $$QT_BUILD_TREE/src/corelib/global
 
diff --git a/src/corelib/global/qmalloc.cpp b/src/corelib/global/qmalloc.cpp
index 090998c..6bb8691 100644
--- a/src/corelib/global/qmalloc.cpp
+++ b/src/corelib/global/qmalloc.cpp
@@ -41,6 +41,8 @@
 
 #include "qplatformdefs.h"
 
+#include "dlmalloc.h"
+
 #include <stdlib.h>
 
 /*
@@ -52,17 +54,29 @@ QT_BEGIN_NAMESPACE
 
 void *qMalloc(size_t size)
 {
-    return ::malloc(size);
+#ifdef _WIN32_WCE
+    return ::dlmalloc(size);
+#else
+	return ::malloc(size);
+#endif
 }
 
 void qFree(void *ptr)
 {
-    ::free(ptr);
+#ifdef _WIN32_WCE
+    ::dlfree(ptr);
+#else
+	::free(ptr);
+#endif
 }
 
 void *qRealloc(void *ptr, size_t size)
 {
-    return ::realloc(ptr, size);
+#ifdef _WIN32_WCE
+    return ::dlrealloc(ptr, size);
+#else
+	return realloc(ptr, size);
+#endif
 }
 
 void *qMallocAligned(size_t size, size_t alignment)
-- 
1.7.0.2.msysgit.0

