From fe7979b50c643567c48aa0df95d45c67f68c7532 Mon Sep 17 00:00:00 2001
From: Andre Heinecke <aheinecke@intevation.de>
Date: Thu, 28 Apr 2011 09:05:54 +0000
Subject: [PATCH] Add full shutdown button

---
 kontact/src/kontactui.rc   |    1 +
 kontact/src/mainwindow.cpp |   26 +++++++++++++++++++++++++-
 kontact/src/mainwindow.h   |    1 +
 3 files changed, 27 insertions(+), 1 deletions(-)

diff --git a/kontact/src/kontactui.rc b/kontact/src/kontactui.rc
index 9125e14..f35536e 100644
--- a/kontact/src/kontactui.rc
+++ b/kontact/src/kontactui.rc
@@ -8,6 +8,7 @@
     <Separator/>
     <Action name="action_new"/>
     <Separator/>
+    <Action name="full_shutdown"/>
     <Action name="file_quit"/>
     <Merge/>
   </Menu>
diff --git a/kontact/src/mainwindow.cpp b/kontact/src/mainwindow.cpp
index 1f1775e..1016a42 100644
--- a/kontact/src/mainwindow.cpp
+++ b/kontact/src/mainwindow.cpp
@@ -31,6 +31,7 @@ using namespace Kontact;
 #include <libkdepim/broadcaststatus.h>
 #include <libkdepim/progressdialog.h>
 #include <libkdepim/statusbarprogresswidget.h>
+#include <akonadi/servermanager.h>
 
 #include <KontactInterface/Core>
 #include <KontactInterface/Plugin>
@@ -70,6 +71,7 @@ using namespace Kontact;
 #include <QTimer>
 #include <QVBoxLayout>
 #include <QWebSettings>
+#include <QProcess>
 
 // This class extends the normal KDBusServiceStarter.
 //
@@ -385,6 +387,7 @@ void MainWindow::initAboutScreen()
 
 void MainWindow::setupActions()
 {
+
   actionCollection()->addAction( KStandardAction::Quit, this, SLOT(slotQuit()) );
 
   mNewActions = new KActionMenu(
@@ -394,6 +397,10 @@ void MainWindow::setupActions()
   mNewActions->setShortcut( KStandardShortcut::openNew() );
   connect( mNewActions, SIGNAL(triggered(bool)), this, SLOT(slotNewClicked()) );
 
+  KAction *action = new KAction(KIcon( "system-shutdown" ),  i18n( "Full Shutdown" ), this );
+  actionCollection()->addAction( "full_shutdown" , action );
+  connect( action, SIGNAL( triggered() ), SLOT( slotFullShutdown() ) );
+
   // If the user is using disconnected imap mail folders as groupware, we add
   // plugins' Synchronize actions to the toolbar which trigger an imap sync.
   // Otherwise it's redundant and misleading.
@@ -417,7 +424,7 @@ void MainWindow::setupActions()
     connect( mSyncActions, SIGNAL(triggered(bool)), this, SLOT(slotSyncClicked()) );
   }
 
-  KAction *action =
+  action =
     new KAction( KIcon( "configure" ),
                  i18nc( "@action:inmenu", "Configure Kontact..." ), this );
   action->setHelpText(
@@ -969,6 +976,23 @@ void MainWindow::showTip( bool force )
   KTipDialog::showMultiTip( this, tips, force );
 }
 
+void MainWindow::slotFullShutdown()
+{
+  const QString message = i18n( "A full shutdown will disable notifications\nabout new emails and upcoming events." );
+  const int result = KMessageBox::warningContinueCancel( 0, message );
+
+  if ( result == KMessageBox::Cancel )
+    return;
+
+  Akonadi::ServerManager::self()->stop(); 
+#ifdef Q_OS_WIN
+  const QString path = KStandardDirs::findExe( QLatin1String("kdeinit4" ) );
+  QProcess::startDetached( path + " --terminate" );
+#endif
+  // TODO: Kill KOrgac Nepomuk and so on softly
+  close();
+}
+
 void MainWindow::slotQuit()
 {
   mReallyClose = true;
diff --git a/kontact/src/mainwindow.h b/kontact/src/mainwindow.h
index 24c6f29..fe1d9e2 100644
--- a/kontact/src/mainwindow.h
+++ b/kontact/src/mainwindow.h
@@ -83,6 +83,7 @@ class KONTACT_EXPORT MainWindow : public KontactInterface::Core
     void slotNewClicked();
     void slotSyncClicked();
     void slotQuit();
+    void slotFullShutdown();
     void slotShowTip();
     void slotShowTipOnStart();
     void slotNewToolbarConfig();
-- 
1.7.0.4

