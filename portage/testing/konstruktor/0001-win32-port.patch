From ed2bd8e68fed58b842bc44a97a5e4e834c4650c4 Mon Sep 17 00:00:00 2001
From: Ralf Habacker <ralf.habacker@freenet.de>
Date: Fri, 4 Feb 2011 18:12:16 +0100
Subject: [PATCH] win32 port

---
 CMakeLists.txt                             |    5 +++++
 src/libldr/CMakeLists.txt                  |    3 ++-
 src/libldr/exception.h                     |    4 ++++
 src/renderer/opengl_extension.cpp          |    6 +++++-
 src/renderer/opengl_extension_shader.h     |    4 ++++
 src/renderer/opengl_extension_vbo.h        |    4 ++++
 src/renderer/renderer_opengl.cpp           |    3 +++
 src/renderer/renderer_opengl_immediate.cpp |    4 ++++
 src/renderer/renderer_opengl_retained.cpp  |    4 ++++
 9 files changed, 35 insertions(+), 2 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 9fd5c30..2301f21 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -7,9 +7,14 @@ include_directories(${CMAKE_SOURCE_DIR}/src)
 find_package(KDE4 REQUIRED)
 find_package(OpenGL REQUIRED)
 find_package(Sqlite REQUIRED)
+find_package(Kdewin REQUIRED)
 
 include_directories(${KDE4_INCLUDES})
 
+if (WIN32)
+add_definitions(-DWIN32)
+endif()
+
 if(DEBUG_PROFILE)
 add_definitions(-pg)
 endif(DEBUG_PROFILE)
diff --git a/src/libldr/CMakeLists.txt b/src/libldr/CMakeLists.txt
index c9b41b6..bc7c891 100644
--- a/src/libldr/CMakeLists.txt
+++ b/src/libldr/CMakeLists.txt
@@ -28,11 +28,12 @@ set(libldr_HEADERS
   utils.h
   writer.h
 )
+include_directories(${KDEWIN_INCLUDES})
 
 add_library(libldr SHARED ${libldr_SOURCES})
 set_target_properties(libldr PROPERTIES OUTPUT_NAME ldraw)
 set_target_properties(libldr PROPERTIES VERSION 0.5.0 SOVERSION 1)
-
+target_link_libraries(libldr ${KDEWIN_LIBRARIES})
 # install
 install(TARGETS libldr DESTINATION ${INSTALL_TARGETS_DEFAULT_ARGS})
 install(FILES ${libldr_HEADERS} DESTINATION ${INCLUDE_INSTALL_DIR}/libldr)
diff --git a/src/libldr/exception.h b/src/libldr/exception.h
index 065e0e2..e4f7aab 100644
--- a/src/libldr/exception.h
+++ b/src/libldr/exception.h
@@ -10,6 +10,10 @@
 #include <exception>
 #include <string>
 
+#ifndef __func__
+#define __func__ __FUNCTION__
+#endif
+
 namespace ldraw {
 
 class LIBLDR_EXPORT exception : public std::exception
diff --git a/src/renderer/opengl_extension.cpp b/src/renderer/opengl_extension.cpp
index 798b4e2..f60ebfb 100644
--- a/src/renderer/opengl_extension.cpp
+++ b/src/renderer/opengl_extension.cpp
@@ -6,6 +6,10 @@
 
 #include <cstring>
 
+#if defined(WIN32)
+#include <windows.h>
+#endif
+
 #include <GL/gl.h>
 
 #if defined(WIN32)
@@ -42,7 +46,7 @@ bool opengl_extension::is_supported() const
 opengl_extension::func_ptr opengl_extension::get_glext_proc(const char *procname)
 {
 #if defined(WIN32)
-	return wglGetProcAddress(procname);
+	return (opengl_extension::func_ptr) wglGetProcAddress(procname);
 #else
 	return glXGetProcAddress((const GLubyte *)procname);
 #endif
diff --git a/src/renderer/opengl_extension_shader.h b/src/renderer/opengl_extension_shader.h
index b8e701f..2175690 100644
--- a/src/renderer/opengl_extension_shader.h
+++ b/src/renderer/opengl_extension_shader.h
@@ -7,6 +7,10 @@
 #ifndef _RENDERER_OPENGL_EXTENSION_VSHADER_H_
 #define _RENDERER_OPENGL_EXTENSION_VSHADER_H_
 
+#if defined(WIN32)
+#include <windows.h>
+typedef char GLchar;
+#endif
 #include <GL/gl.h>
 
 #include <libldr/common.h>
diff --git a/src/renderer/opengl_extension_vbo.h b/src/renderer/opengl_extension_vbo.h
index d76f907..2bd0f9a 100644
--- a/src/renderer/opengl_extension_vbo.h
+++ b/src/renderer/opengl_extension_vbo.h
@@ -7,6 +7,10 @@
 #ifndef _RENDERER_OPENGL_EXTENSION_VBO_H_
 #define _RENDERER_OPENGL_EXTENSION_VBO_H_
 
+#if defined(WIN32)
+#include <windows.h>
+#endif
+
 #include <GL/gl.h>
 
 #include <libldr/common.h>
diff --git a/src/renderer/renderer_opengl.cpp b/src/renderer/renderer_opengl.cpp
index 8fb38e2..98763e3 100644
--- a/src/renderer/renderer_opengl.cpp
+++ b/src/renderer/renderer_opengl.cpp
@@ -4,6 +4,9 @@
  *                                                                                   *
  * Author: (c)2006-2010 Park "segfault" J. K. <mastermind_at_planetmono_dot_org>     */
 
+#ifdef _WIN32
+#include <windows.h>
+#endif
 #include <GL/gl.h>
 
 #include "opengl_extension_vbo.h"
diff --git a/src/renderer/renderer_opengl_immediate.cpp b/src/renderer/renderer_opengl_immediate.cpp
index e731d60..2d1e620 100644
--- a/src/renderer/renderer_opengl_immediate.cpp
+++ b/src/renderer/renderer_opengl_immediate.cpp
@@ -4,6 +4,10 @@
  *                                                                                   *
  * Author: (c)2006-2008 Park "segfault" J. K. <mastermind_at_planetmono_dot_org>     */
 
+#if defined(WIN32)
+#include <windows.h>
+#endif
+
 #include <GL/gl.h>
 #include <GL/glu.h>
 
diff --git a/src/renderer/renderer_opengl_retained.cpp b/src/renderer/renderer_opengl_retained.cpp
index 9f6b8a8..b953abe 100644
--- a/src/renderer/renderer_opengl_retained.cpp
+++ b/src/renderer/renderer_opengl_retained.cpp
@@ -4,6 +4,10 @@
  *                                                                                   *
  * Author: (c)2006-2008 Park "segfault" J. K. <mastermind_at_planetmono_dot_org>     */
 
+#if defined(WIN32)
+#include <windows.h>
+#endif
+
 #define GL_GLEXT_PROTOTYPES
 #include <GL/gl.h>
 #include <GL/glu.h>
-- 
1.7.0.2.msysgit.0

